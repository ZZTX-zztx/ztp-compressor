<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZTP åŠ å¯†å™¨ - æ–°å¹´å¿«ä¹</title>
<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://unpkg.com/crypto-js@4.2.0/crypto-js.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,sans-serif}
body{background:#fff0f0;padding:20px;max-width:500px;margin:0 auto}
.card{background:#fff;border-radius:16px;padding:20px;margin-bottom:16px;box-shadow:0 4px 12px rgba(255,0,0,.08)}
.title{font-size:18px;font-weight:700;color:#d92c2c;margin-bottom:12px}
.area{border:2px dashed #ffb3b3;border-radius:12px;padding:28px 10px;text-align:center;color:#666;margin-bottom:12px}
.area input{display:none}
.btn{background:#d92c2c;color:#fff;border:none;border-radius:10px;padding:12px;width:100%;font-size:15px;font-weight:600;margin-top:6px}
.pwd{width:100%;padding:10px 12px;border:1px solid #ffcccc;border-radius:10px;margin-bottom:10px}
.progress{height:6px;background:#ffd6d6;border-radius:3px;overflow:hidden;margin:10px 0}
.bar{height:100%;background:#d92c2c;width:0;transition:.2s}
.status{font-size:14px;color:#666}
</style>
</head>
<body>

<div class="card">
  <div class="title">ğŸ§§ æ–°å¹´ç‰ˆ ZTP åŠ å¯†å™¨</div>
  <input class="pwd" id="zipPwd" placeholder="è®¾ç½®åŠ å¯†å¯†ç " type="password">
  <div class="area" id="zipArea">
    <p>ç‚¹å‡»æˆ–æ‹–æ”¾æ–‡ä»¶/æ–‡ä»¶å¤¹</p>
    <input type="file" id="zipFiles" multiple webkitdirectory>
  </div>
  <button class="btn" id="doZip">ç”Ÿæˆ .ztp åŠ å¯†åŒ…</button>
  <div class="progress"><div class="bar" id="zipBar"></div></div>
  <div class="status" id="zipLog"></div>
</div>

<div class="card">
  <div class="title">ğŸ“‚ è§£å¯†è§£å‹</div>
  <input class="pwd" id="unzipPwd" placeholder="è¾“å…¥è§£å¯†å¯†ç " type="password">
  <div class="area" id="unzipArea">
    <p>é€‰æ‹© .ztp æ–‡ä»¶</p>
    <input type="file" id="unzipFile" accept=".ztp">
  </div>
  <button class="btn" id="doUnzip">è§£å¯†å¹¶è§£å‹</button>
  <div class="progress"><div class="bar" id="unzipBar"></div></div>
  <div class="status" id="unzipLog"></div>
</div>

<script>
const MAGIC = "ZTPv2-ZETA";
const XOR_KEY = 0x9D;
const DEFAULT_PWD = "123456";

function setBar(id, v) {
  document.getElementById(id).style.width = Math.min(100, v) + "%";
}

function xorBuf(buf, key) {
  const u = new Uint8Array(buf);
  for (let i = 0; i < u.length; i++) u[i] ^= key;
  return u;
}

function aesEncrypt(data, pwd) {
  return CryptoJS.AES.encrypt(CryptoJS.lib.WordArray.create(data), pwd).toString();
}

function aesDecrypt(b64, pwd) {
  try {
    const d = CryptoJS.AES.decrypt(b64, pwd);
    return new Uint8Array(Array.from(d.words).flatMap(w => [
      (w >>> 24) & 0xff, (w >>> 16) & 0xff, (w >>> 8) & 0xff, w & 0xff
    ]));
  } catch {
    throw new Error("å¯†ç é”™è¯¯");
  }
}

document.getElementById("doZip").onclick = async () => {
  const files = Array.from(document.getElementById("zipFiles").files);
  const pwd = document.getElementById("zipPwd").value || DEFAULT_PWD;
  const log = document.getElementById("zipLog");
  const bar = document.getElementById("zipBar");
  if (!files.length) return log.textContent = "è¯·é€‰æ‹©æ–‡ä»¶";
  log.textContent = "æ‰“åŒ…ä¸­...";
  setBar("zipBar", 20);

  const zip = new JSZip();
  files.forEach(f => zip.file(f.webkitRelativePath || f.name, f));
  const bin = await zip.generateAsync({ type: "uint8array" });
  setBar("zipBar", 50);

  const aes = aesEncrypt(bin, pwd);
  const enc = xorBuf(new TextEncoder().encode(aes), XOR_KEY);
  setBar("zipBar", 80);

  const head = new TextEncoder().encode(MAGIC);
  const out = new Uint8Array(head.length + enc.length);
  out.set(head);
  out.set(enc, head.length);

  saveAs(new Blob([out]), "åŠ å¯†æ–‡ä»¶.ztp");
  setBar("zipBar", 100);
  log.textContent = "âœ… åŠ å¯†å®Œæˆ";
};

document.getElementById("doUnzip").onclick = async () => {
  const file = document.getElementById("unzipFile").files[0];
  const pwd = document.getElementById("unzipPwd").value || DEFAULT_PWD;
  const log = document.getElementById("unzipLog");
  if (!file) return log.textContent = "è¯·é€‰æ‹© .ztp æ–‡ä»¶";
  log.textContent = "æ ¡éªŒä¸­...";
  setBar("unzipBar", 20);

  const buf = await file.arrayBuffer();
  const arr = new Uint8Array(buf);
  const magic = new TextDecoder().decode(arr.slice(0, MAGIC.length));
  if (magic !== MAGIC) return log.textContent = "âŒ ä¸æ˜¯åˆæ³• ZTP æ–‡ä»¶";

  setBar("unzipBar", 40);
  const data = xorBuf(arr.slice(MAGIC.length), XOR_KEY);
  const b64 = new TextDecoder().decode(data);

  let bin;
  try {
    bin = aesDecrypt(b64, pwd);
  } catch {
    log.textContent = "âŒ å¯†ç é”™è¯¯";
    return;
  }

  setBar("unzipBar", 70);
  const zip = new JSZip();
  const z = await zip.loadAsync(bin);
  for (const name in z.files) {
    if (!z.files[name].dir) {
      const blob = await z.files[name].async("blob");
      saveAs(blob, name);
    }
  }
  setBar("unzipBar", 100);
  log.textContent = "âœ… è§£å¯†å®Œæˆ";
};

document.getElementById("zipArea").onclick = () => document.getElementById("zipFiles").click();
document.getElementById("unzipArea").onclick = () => document.getElementById("unzipFile").click();
</script>
</body>
</html>
